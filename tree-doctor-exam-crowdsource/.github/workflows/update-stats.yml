name: Update Statistics

on:
  push:
    branches: [main]
    paths:
      - 'data/**/*.json'
  schedule:
    - cron: '0 0 * * *'  # Daily at midnight
  workflow_dispatch:

jobs:
  update-stats:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
    
    - name: Calculate Statistics
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          const path = require('path');
          
          // Statistics object
          const stats = {
            totalQuestions: 0,
            verifiedQuestions: 0,
            byYear: {},
            bySubject: {},
            contributors: {},
            verifiers: {},
            lastUpdated: new Date().toISOString()
          };
          
          // Process all JSON files
          const processDirectory = (dir) => {
            const files = fs.readdirSync(dir);
            
            for (const file of files) {
              const filePath = path.join(dir, file);
              const stat = fs.statSync(filePath);
              
              if (stat.isDirectory()) {
                processDirectory(filePath);
              } else if (file.endsWith('.json') && !file.startsWith('_')) {
                try {
                  const content = fs.readFileSync(filePath, 'utf8');
                  const data = JSON.parse(content);
                  
                  // Count total
                  stats.totalQuestions++;
                  
                  // Count verified
                  if (data.verifiedBy && data.verifiedBy.length >= 2) {
                    stats.verifiedQuestions++;
                  }
                  
                  // By year and round
                  const yearKey = `${data.year}`;
                  if (!stats.byYear[yearKey]) {
                    stats.byYear[yearKey] = { total: 0, verified: 0, rounds: {} };
                  }
                  stats.byYear[yearKey].total++;
                  if (data.verifiedBy && data.verifiedBy.length >= 2) {
                    stats.byYear[yearKey].verified++;
                  }
                  
                  const roundKey = `round-${data.round}`;
                  if (!stats.byYear[yearKey].rounds[roundKey]) {
                    stats.byYear[yearKey].rounds[roundKey] = { total: 0, verified: 0 };
                  }
                  stats.byYear[yearKey].rounds[roundKey].total++;
                  if (data.verifiedBy && data.verifiedBy.length >= 2) {
                    stats.byYear[yearKey].rounds[roundKey].verified++;
                  }
                  
                  // By subject
                  if (!stats.bySubject[data.subject]) {
                    stats.bySubject[data.subject] = { total: 0, verified: 0 };
                  }
                  stats.bySubject[data.subject].total++;
                  if (data.verifiedBy && data.verifiedBy.length >= 2) {
                    stats.bySubject[data.subject].verified++;
                  }
                  
                  // Contributors
                  if (data.contributor) {
                    if (!stats.contributors[data.contributor]) {
                      stats.contributors[data.contributor] = 0;
                    }
                    stats.contributors[data.contributor]++;
                  }
                  
                  // Verifiers
                  if (data.verifiedBy) {
                    for (const verifier of data.verifiedBy) {
                      if (!stats.verifiers[verifier]) {
                        stats.verifiers[verifier] = 0;
                      }
                      stats.verifiers[verifier]++;
                    }
                  }
                  
                } catch (e) {
                  console.error(`Error processing ${filePath}: ${e.message}`);
                }
              }
            }
          };
          
          // Start processing
          if (fs.existsSync('data')) {
            processDirectory('data');
          }
          
          // Sort contributors and verifiers
          const topContributors = Object.entries(stats.contributors)
            .sort(([,a], [,b]) => b - a)
            .slice(0, 10);
          
          const topVerifiers = Object.entries(stats.verifiers)
            .sort(([,a], [,b]) => b - a)
            .slice(0, 10);
          
          // Generate badge functions
          const getBadge = (count, type) => {
            if (type === 'contributor') {
              if (count >= 100) return 'ğŸ”ï¸ ì‚° ê¸°ì—¬ì';
              if (count >= 51) return 'ğŸŒ² ìˆ² ê¸°ì—¬ì';
              if (count >= 21) return 'ğŸŒ³ ë‚˜ë¬´ ê¸°ì—¬ì';
              if (count >= 6) return 'ğŸŒ¿ ì„±ì¥ ê¸°ì—¬ì';
              return 'ğŸŒ± ìƒˆì‹¹ ê¸°ì—¬ì';
            } else {
              if (count >= 100) return 'ğŸ… ë§ˆìŠ¤í„° ê²€ì¦ì';
              if (count >= 50) return 'ğŸ” ì „ë¬¸ ê²€ì¦ì';
              if (count >= 10) return 'ğŸ” ê²€ì¦ì';
              return '';
            }
          };
          
          // Update README
          let readme = fs.readFileSync('README.md', 'utf8');
          
          // Update progress bar
          const progress = Math.round((stats.verifiedQuestions / 800) * 100);
          readme = readme.replace(
            /!\[ì§„í–‰ë¥ \]\(https:\/\/progress-bar\.dev\/\d+\/\?title=[^)]+\)/,
            `![ì§„í–‰ë¥ ](https://progress-bar.dev/${progress}/?title=ì „ì²´%20ì§„í–‰ë¥ )`
          );
          
          // Update statistics table
          const tableRows = [];
          const years = ['2023', '2022'];
          const rounds = [1, 2];
          
          for (const year of years) {
            for (const round of rounds) {
              const yearStats = stats.byYear[year]?.rounds[`round-${round}`] || { total: 0, verified: 0 };
              const progress = yearStats.total > 0 ? Math.round((yearStats.verified / 200) * 100) : 0;
              tableRows.push(`| ${year} | ${round}íšŒ | 200 | ${yearStats.total} | ${yearStats.verified} | ${progress}% |`);
            }
          }
          
          const tableSection = `| ì—°ë„ | íšŒì°¨ | ì´ ë¬¸ì œ ìˆ˜ | ì…ë ¥ ì™„ë£Œ | ê²€ì¦ ì™„ë£Œ | ì§„í–‰ë¥  |
|------|------|-----------|-----------|-----------|--------|
${tableRows.join('\n')}`;
          
          readme = readme.replace(
            /\| ì—°ë„ \| íšŒì°¨ \| ì´ ë¬¸ì œ ìˆ˜[\s\S]+?(?=\n\n)/,
            tableSection
          );
          
          // Update current stats
          readme = readme.replace(
            /- ì´ ì…ë ¥ëœ ë¬¸ì œ: \d+ê°œ/,
            `- ì´ ì…ë ¥ëœ ë¬¸ì œ: ${stats.totalQuestions}ê°œ`
          );
          readme = readme.replace(
            /- ê²€ì¦ ì™„ë£Œëœ ë¬¸ì œ: \d+ê°œ/,
            `- ê²€ì¦ ì™„ë£Œëœ ë¬¸ì œ: ${stats.verifiedQuestions}ê°œ`
          );
          readme = readme.replace(
            /- ì°¸ì—¬ ê¸°ì—¬ì: \d+ëª…/,
            `- ì°¸ì—¬ ê¸°ì—¬ì: ${Object.keys(stats.contributors).length}ëª…`
          );
          
          // Add Hall of Fame section if not exists or update it
          const hallOfFameSection = `
## ğŸ† ëª…ì˜ˆì˜ ì „ë‹¹

### ì´ë²ˆ ë‹¬ ìµœê³  ê¸°ì—¬ì
${topContributors.slice(0, 3).map(([name, count], index) => 
  `${index + 1}. @${name} - ${count}ê°œ ë¬¸ì œ ${getBadge(count, 'contributor')}`
).join('\n')}

### ìµœê³  ê²€ì¦ì
${topVerifiers.slice(0, 3).map(([name, count], index) => 
  `${index + 1}. @${name} - ${count}ê°œ ê²€ì¦ ${getBadge(count, 'verifier')}`
).join('\n')}

### ì „ì²´ ê¸°ì—¬ì ìˆœìœ„
<details>
<summary>ì „ì²´ ë³´ê¸°</summary>

| ìˆœìœ„ | ê¸°ì—¬ì | ë¬¸ì œ ìˆ˜ | ë°°ì§€ |
|------|--------|---------|------|
${topContributors.map(([name, count], index) => 
  `| ${index + 1} | @${name} | ${count} | ${getBadge(count, 'contributor')} |`
).join('\n')}

</details>`;
          
          if (readme.includes('## ğŸ† ëª…ì˜ˆì˜ ì „ë‹¹')) {
            readme = readme.replace(
              /## ğŸ† ëª…ì˜ˆì˜ ì „ë‹¹[\s\S]+?(?=##|$)/,
              hallOfFameSection + '\n\n'
            );
          } else {
            // Insert before í˜„ì¬ ì§„í–‰ ìƒí™©
            readme = readme.replace(
              '## ğŸ“Š í˜„ì¬ ì§„í–‰ ìƒí™©',
              hallOfFameSection + '\n\n## ğŸ“Š í˜„ì¬ ì§„í–‰ ìƒí™©'
            );
          }
          
          fs.writeFileSync('README.md', readme);
          
          // Save statistics JSON
          fs.writeFileSync('stats.json', JSON.stringify(stats, null, 2));
          
          // Commit changes
          const { execSync } = require('child_process');
          execSync('git config user.name "github-actions[bot]"');
          execSync('git config user.email "github-actions[bot]@users.noreply.github.com"');
          execSync('git add README.md stats.json');
          
          try {
            execSync('git commit -m "chore: ìë™ í†µê³„ ì—…ë°ì´íŠ¸"');
            execSync('git push');
          } catch (e) {
            console.log('No changes to commit');
          }